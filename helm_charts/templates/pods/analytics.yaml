apiVersion: batch/v1
kind: CronJob
metadata:
  name: analytics
  namespace: chatbot # Use the namespace where your ClickHouse is
spec:
  # Run every day at 2 AM UTC
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          # Use the Kubernetes Service Account linked with Workload Identity
          serviceAccountName: analytics-sa
          containers:
          - name: analytics
            # Use the custom image you built and pushed
            image: europe-west1-docker.pkg.dev/brain-staging-450115/clickhouse-analytics/clickhouse-analytics:latest
            # The command to run
            command:
              - >
                clickhouse-client --host "$CLICKHOUSE_SERVICE_NAME" --user "$CLICKHOUSE_USERNAME" --password "$CLICKHOUSE_PASSWORD" --query "SELECT id, name, timestamp, user_id, tags, session_id, FROM default.
                traces ORDER BY timestamp DESC FORMAT CSVWithNames" |gsutil cp - gs://brain-langfuse-monitor/batch_2/$(date +%Y-%m-%d)-table-extract_3.csv
            env:
              - name: CLICKHOUSE_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: my-clickhouse-secret 
                    key: password             
              - name: CLICKHOUSE_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: my-clickhouse-secret 
                    key: username    
              - name: CLICKHOUSE_SERVICE_NAME
                valueFrom:
                  secretKeyRef:
                    name: my-clickhouse-secret 
                    key:  service_name
          restartPolicy: OnFailure    