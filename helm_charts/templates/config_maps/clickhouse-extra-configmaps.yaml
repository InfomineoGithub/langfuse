{{- if .Values.backup.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.clickhouse.fullnameOverride }}-extra-configs
  namespace: {{ .Values.namespace }}
data:
  dhparam.pem: |
    # Paste the entire content of your dhparam.pem file here
    # It starts with -----BEGIN DH PARAMETERS-----
    -----BEGIN DH PARAMETERS-----
    MIIBCAKCAQEAnuJzt7KftC+FgYRVjAIENTfH70iBLl1WMhzrcG0rfibk1EmrFjSh
    bovvv18TVjm7cCFYpVPUmi7U7IK8d4EK0AfQepCWQWmeAc482yk8qG6C1pDrew4n
    zW7FnJlN82PPINuVm5BXRDsC49SLMMb7C/Cytzd/ULjztKBmF1J5IaCWBc9tlhTR
    KOkJY347wVJ8htSOymeJtPOncIcECEDZaGE3n+Xzt2rfdLfRaqKLDq1Ce6rCu4ka
    WvDOSE6kPu6JKFrvuHLopW1Nv/KAcEbNOgU51qoWisCgcOe+aq4YKwtqGmqoXkoR
    96/UtH5od3oIdzbE6iOny8y9V9QP9ZPIfwIBAg==
    -----END DH PARAMETERS-----

  secure-ports.xml: |
    <yandex>
        <openSSL>
            <server>
                <certificateFile>/tmp/certs/tls.crt</certificateFile>
                <privateKeyFile>/tmp/certs/tls.key</privateKeyFile>
                <dhParamsFile>/etc/clickhouse-server/config.d/dhparam.pem</dhParamsFile>
                <verificationMode>none</verificationMode>
                <loadDefaultCAFile>true</loadDefaultCAFile>
                <cacheSessions>true</cacheSessions>
                <disableProtocols>sslv2,sslv3,tlsv1,tlsv1_1</disableProtocols>
                <preferServerCiphers>true</preferServerCiphers>
            </server>
        </openSSL>
        <mysql_port_ssl>9006</mysql_port_ssl>
        <https_port>0</https_port>
        <tcp_port_ssl>0</tcp_port_ssl>
    </yandex>

  storage-gcs.xml: |
    <clickhouse>
      <storage_configuration>
        <disks>
          <backups>
            <type>s3_plain</type>
            <endpoint>https://storage.googleapis.com/{{ .Values.backup.gcsBucket }}/{{ .Values.backup.gcsPath }}/</endpoint>
            <access_key_id from_env="ACCESS_KEY_ID"/>
            <secret_access_key from_env="SECRET_ACCESS_KEY"/>
            <support_batch_delete>false</support_batch_delete>
          </backups>
        </disks>
        <policies>
          <backups_policy>
            <volumes>
              <main>
                <disk>backups</disk>
              </main>
            </volumes>
          </backups_policy>
        </policies>
      </storage_configuration>
      <backups>
        <allowed_disk>backups</allowed_disk>
      </backups>
    </clickhouse>
{{- end }}
